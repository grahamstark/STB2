<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <title>Conjoint</title>
    <link rel="icon" href="images/favicon.png">
    <link rel="stylesheet" href="css/northumbria-bootstrap.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    </script><script type='text/javascript' src='js/jquery.js'></script>
    <script type='text/javascript' src='js/jquery.periodicalupdater.js'></script>
    <script type='text/javascript' src='js/jquery.validate.js'></script>
     <!-- bootstrap -->
    <script src="js/bootstrap.bundle.js"></script>
    <!-- vega graphics -->
    <script type="text/javascript" src="js/vega-lite.min.js"></script>
    <script type="text/javascript" src="js/vega.js"></script>
    <script type="text/javascript" src="js/vega-embed.min.js"></script>
    <!-- templates -->
    <script type='text/javascript' src="js/mustache.min.js"></script>
   
</head>
<body class='text-primary'>
    
         <header class="">
            <nav class="navbar navbar-dark text-bg-primary  text-center position-relative">
                <a href='https://northumbria.ac.uk'><img src='images/NU_Logo_White.svg' height='120' position-absolute top-0 start-0 /></a> <div class="display-4 position-absolute top-25 start-50 translate-middle-x">Basic Income Conjoint Demo</div>
            </nav>
        </header>
        
        <form id='mainform' action="thing" method="POST">       
            <div class='container-fluid'>                 
                <div class='row'><!-- input row -->
                    <fieldset class="col border  m-1 p-2">
                        <legend>Basic Income - How much?</legend>
                        <div class="form-check">
                            <input class='form-check-input' checked='' type='radio' name='Level' id='Level-1' value='Child - £0; Adult - £63; Pensioner - £190'  />
                            <label class='form-check-label' for='Level-1'>Child - £0; Adult - £63; Pensioner - £190</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio' name='Level' id='Level-2' value='Child - £41; Adult - £63; Pensioner - £190'  />
                            <label class='form-check-label' for='Level-2'>Child - £41; Adult - £63; Pensioner - £190</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio' name='Level' id='Level-3' value='Child - £0; Adult - £145; Pensioner - £190'  />
                            <label class='form-check-label' for='Level-3'>Child - £0; Adult - £145; Pensioner - £190</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio' name='Level' id='Level-4' value='Child - £41; Adult - £145; Pensioner - £190'  />
                            <label class='form-check-label' for='Level-4'>Child - £41; Adult - £145; Pensioner - £190</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio' name='Level' id='Level-5' value='Child - £63; Adult - £145; Pensioner - £190'  />
                            <label class='form-check-label' for='Level-5'>Child - £63; Adult - £145; Pensioner - £190</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio' name='Level' id='Level-6' value='Child - £63; Adult - £190; Pensioner - £190'  />
                            <label class='form-check-label' for='Level-6'>Child - £63; Adult - £190; Pensioner - £190</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio' name='Level' id='Level-7' value='Child - £95; Adult - £190; Pensioner - £230'  />
                            <label class='form-check-label' for='Level-7'>Child - £95; Adult - £190; Pensioner - £230</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio' name='Level' id='Level-8' value='Child - £41; Adult - £230; Pensioner - £230'  />
                            <label class='form-check-label' for='Level-8'>Child - £41; Adult - £230; Pensioner - £230</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio' name='Level' id='Level-9' value='Child - £95; Adult - £230; Pensioner - £230'  />
                            <label class='form-check-label' for='Level-9'>Child - £95; Adult - £230; Pensioner - £230</label>
                        </div>

                    </fieldset>
                    
                    <fieldset class='col border  m-1 p-2'>
                        <legend>How to pay - income tax Rates</legend>
                            <div class="form-check">
                                <input class='form-check-input' checked='' type='radio' name='Tax' id='Tax-1' value='Basic rate - 20%; Higher rate - 40%; Additional rate - 45%'  />
                                    <label class='form-check-label' for='Tax-1'>Basic rate - 20%; Higher rate - 40%; Additional rate - 45%</label>
                                </div>
                                <div class="form-check">
                                    <input class='form-check-input' type='radio' name='Tax' id='Tax-2' value='Basic rate - 23%; Higher rate - 43%; Additional rate - 48%'  />
                                    <label class='form-check-label' for='Tax-2'>Basic rate - 23%; Higher rate - 43%; Additional rate - 48%</label>
                                </div>
                                <div class="form-check">
                                    <input class='form-check-input' type='radio' name='Tax' id='Tax-3' value='Basic rate - 30%; Higher rate - 50%; Additional rate - 60%'  />
                                    <label class='form-check-label' for='Tax-3'>Basic rate - 30%; Higher rate - 50%; Additional rate - 60%</label>
                                </div>
                                <div class="form-check">
                                    <input class='form-check-input' type='radio' name='Tax' id='Tax-4' value='Basic rate - 40%; Higher rate - 60%; Additional rate - 70%'  />
                                    <label class='form-check-label' for='Tax-4'>Basic rate - 40%; Higher rate - 60%; Additional rate - 70%</label>
                                </div>
                                <div class="form-check">
                                    <input class='form-check-input' type='radio' name='Tax' id='Tax-5' value='Basic rate - 48%; Higher rate - 68%; Additional rate - 78%'  />
                                    <label class='form-check-label' for='Tax-5'>Basic rate - 48%; Higher rate - 68%; Additional rate - 78%</label>
                                </div>
                                <div class="form-check">
                                    <input class='form-check-input' type='radio' name='Tax' id='Tax-6' value='Basic rate - 50%; Higher rate - 70%; Additional rate - 80%'  />
                                    <label class='form-check-label' for='Tax-6'>Basic rate - 50%; Higher rate - 70%; Additional rate - 80%</label>
                                </div>
                                <div class="form-check">
                                    <input class='form-check-input' type='radio' name='Tax' id='Tax-7' value='Basic rate - 65%; Higher rate - 85%; Additional rate - 95%'  />
                                    <label class='form-check-label' for='Tax-7'>Basic rate - 65%; Higher rate - 85%; Additional rate - 95%</label>
                                </div>
                    </fieldset>
                    
                    <fieldset class='col border   m-1 p-2'>
                        <legend>How to pay- other things</legend>
                        <div class="form-check">
                            <input class='form-check-input' checked='' type='radio' name='Funding' id='Funding-1' value='Removal of income tax-free personal allowance'  />
                            <label class='form-check-label' for='Funding-1'>Removal of income tax-free personal allowance</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio'   disabled='disabled' name='Funding' id='Funding-2' value='Increased government borrowing'  />
                            <label class='form-check-label' for='Funding-2'>Increased government borrowing</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio'   disabled='disabled' name='Funding' id='Funding-3' value='Corporation tax increase'  />
                            <label class='form-check-label' for='Funding-3'>Corporation tax increase</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio'   disabled='disabled' name='Funding' id='Funding-4' value='Tax for businesses based on carbon emissions'  />
                            <label class='form-check-label' for='Funding-4'>Tax for businesses based on carbon emissions</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio'   disabled='disabled' name='Funding' id='Funding-5' value='Tax for individuals based on carbon emissions'  />
                            <label class='form-check-label' for='Funding-5'>Tax for individuals based on carbon emissions</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio'   disabled='disabled' name='Funding' id='Funding-6' value='Tax on wealth'  />
                            <label class='form-check-label' for='Funding-6'>Tax on wealth</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio'   disabled='disabled' name='Funding' id='Funding-7' value='VAT increase'  />
                            <label class='form-check-label' for='Funding-7'>VAT increase</label>
                        </div>
                        <p>GKS NOTES:incidence? </p>
                    </fieldset>
                </div><!-- input row -->
                <div class='row'><!-- input row -->
                    <fieldset class='col border  m-1 p-2 '>
                            <legend>Basic Income - who is entitled?</legend>  
                            <div class="form-check">
                            <input class='form-check-input' checked='' type='radio' name='Eligibility' id='Eligibility-1' value='People in and out of work are entitled'  />
                            <label class='form-check-label' for='Eligibility-1'>People in and out of work are entitled</label>
                            </div>
                            <div class="form-check">
                                <input class='form-check-input' type='radio'  name='Eligibility' id='Eligibility-2' value='Everyone is entitled but people of working age who are not disabled are required to look for work'  />
                                <label class='form-check-label' for='Eligibility-2'>Everyone is entitled but people of working age who are not disabled are required to look for work</label>
                            </div>
                            <div class="form-check">
                                <input class='form-check-input' type='radio' name='Eligibility' id='Eligibility-3' value='Only people in work are entitled'  />
                                <label class='form-check-label' for='Eligibility-3'>Only people in work are entitled</label>
                            </div>
                            <div class="form-check">
                                <input class='form-check-input' type='radio'  name='Eligibility' id='Eligibility-4' value='Only people out of work are entitled'  />
                                <label class='form-check-label' for='Eligibility-4'>Only people out of work are entitled</label>
                            </div>
                            <p>GKS NOTES: is this supposed to be individual/benunit/household entitlement?</p>
                    </fieldset>   
                    
                    <fieldset class='col border  m-1 p-2 '>
                            <legend>Basic Income - should it be means tested?</legend>  
                        <div class="form-check">
                            <input class='form-check-input' checked='' type='radio' name='Means.testing' id='Means.testing-1' value='People with any or no amount of income are entitled to the full benefit'  />
                            <label class='form-check-label' for='Means.testing-1'>People with any or no amount of income are entitled to the full benefit</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio' name='Means.testing' id='Means.testing-2' value='Only those with incomes less than £20k are entitled to the full benefit'  />
                            <label class='form-check-label' for='Means.testing-2'>Only those with incomes less than £20k are entitled to the full benefit</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio'  name='Means.testing' id='Means.testing-3' value='Only those with incomes less than £50k are entitled to the full benefit'  />
                            <label class='form-check-label' for='Means.testing-3'>Only those with incomes less than £50k are entitled to the full benefit</label>
                        </div>
                        <div class="form-check">
                            <input class='form-check-input' type='radio' name='Means.testing' id='Means.testing-4' value='Only those with incomes less than £125k are entitled to the full benefit'  />
                            <label class='form-check-label' for='Means.testing-4'>Only those with incomes less than £125k are entitled to the full benefit</label>
                        </div>
                        <p>GKS NOTES: is this supposed to be individual/benunit/household income?  Do you lose 100% if you're over these amounts? Do we use UC/Taxable income?</p>
                    </fieldset>
                    
                    <fieldset class='col border  m-1 p-2 '>
                            <legend>Basic Income - citizens?</legend>  
                            <div class="form-check">
                                <input class='form-check-input' checked=''   disabled='disabled' type='radio' name='Citizenship' id='Citizenship-1' value='Citizens, permanent residents and anyone residing in the UK for more than six months are entitled'  />
                                <label class='form-check-label' for='Citizenship-1'>Citizens, permanent residents and anyone residing in the UK for more than six months are entitled</label>
                            </div>
                            <div class="form-check">
                                <input class='form-check-input' type='radio'   disabled='disabled' name='Citizenship' id='Citizenship-2' value='Only citizens and permanent residents are entitled'  />
                                <label class='form-check-label' for='Citizenship-2'>Only citizens and permanent residents are entitled</label>
                            </div>
                            <div class="form-check">
                                <input class='form-check-input' type='radio'   disabled='disabled' name='Citizenship' id='Citizenship-3' value='Only citizens are entitled'  />
                                <label class='form-check-label' for='Citizenship-3'>Only citizens are entitled</label>
                            </div>
                            <p>GKS notes: need to model this</p>
                    </fieldset>
                </div> <!-- input row -->
                
                
                <div class="row"> <!-- progress bar -->
                    <div class="col"></div>
                    <div class='col-4' id="progress-indicator"></div>
                    <div class="col"></div>
                </div> <!-- output row -->
                
                <fieldset class="row">
                    <div class="col"></div>
                    <div class="col"></div>
                    <div class="col"></div>
                    <div class="col">
                        <ul class="nav">
                            <li class="nav-item  p-2">                      
                                <button  type="button" class='btn btn-warning ' value='' onclick='submitForm( "reset" )'>Reset</button>
                            </li>
                            <!-- means nothing here
                            <li class="nav-item p-2">                      
                                <button  type="button" class='btn btn-info ' value='' onclick='submitForm( "save" )'>Save</button>
                            </li>
                            -->
                            <li class="nav-item p-2">                      
                                <button  type="button" class='btn btn-success ' value='' onclick='submitForm( "run" )'>Run</button>
                            </li>
                        </ul>
                    </div>
                </fieldset> <!-- submission row -->
                <div class="row  border  m-1 p-2">
                    <div class='col'>
                            <div id='output-fields'>
                                <div class='row'>
        
                                    <div class='col-4'></div>
                                    <div class='col-4'>
                                        <h2>Results for some Example Families</h2>
                                    </div>
                                    <div class='col-4'></div>
                                </div>
                                <div class='row'>
                                    <div class='col-12' id='examples'>
                                       
                                    </div>
                                </div>
                                <div class='row'>
                                    <div class='col-4'></div>
                                    <div class='col-4'>
                                        <h2>Results</h2>
                                    </div>
                                    <div class='col-4'></div>
                                </div>
                                <div class='row'>
                                    <div class='col'>
                                        <h4>Gainers and Losers</h4>
                                        <div class='row'>
                                            <div class='col' id="gain-lose-table">,</div>
                                            <div class='col' id="deciles-graph">,</div>
                                        </div>
                                    </div>
                                                          
                                    <div class='col'>
                                        <h4>Popularity</h4>
                                        <div id="conjoint-table"></div>
                                    </div>      
                                    
                                    <div class='col'>
                                        <h4>Revenues and Costs</h4>
                                        <div
                                            data-bs-toggle='modal' 
                                            data-bs-target='#big-costs-popup'>
                                            <div id="costs-table"></div>
                                        </div>
                                        <div id="overall-costs"></div>
                                    </div>                            
                                </div><!-- row -->
                                <div class='row'>
                                    <div class='col'>
                                        <h4>Poverty</h4>
                                        <div id='pov-table'></div>
                                    </div>
                                    <div class='col'>
                                        <h4>Inequality</h4>
                                        <div id='ineq-table'></div>
                                    </div>
                                    <div class='col'>
                                        <div id='lorenz'></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
         
               </div> <!-- output row -->
               <div class="row">
                   
                    
                    
                </div>
            </div> <!-- main container -->
        </form>
        
        <div id='endnotes' class='p-4' ></div>
        
        <footer>
            <nav class="text-bg-primary  text-center position-relative">
            copyright&copy; 2023 Northumbria University/Virtual Worlds Research/Others | Code: <a href='https://mit-license.org/'>MIT Licence</a> | Text: 
            <a href='https://creativecommons.org/licenses/by-sa/4.0/'>Attribution/Share Alike</a>
            </nav>
        </footer>
</body>

<script type='text/javascript'>



var updater;

function drawRunProgress( data ){
    console.log( "data.completed" + data.completed + "data.size" + data.size );
    var pct = Math.trunc(100 * data.completed / data.size);
    var prog = 
        "<p>Model Running</p>"+
        "<div class='progress'>"+
        "<div class='progress-bar bg-success progress-bar-animated progress-bar-striped' role='progressbar' "+
            "aria-valuenow='" + pct + "' " + 
            "style='width: "+pct+"%' " +
            "aria-valuemin='0' " +
            "aria-valuemax='100'>"+
            pct + "%" +
            "</div> "+
            "</div>";
    console.log( "prog="+prog )
    $("#progress-indicator").html( prog );
}



function createLorenzCurve( targetId, result, thumbnail ){
    var height = 300;
    var xtitle = "Population Share";
    var ytitle = "Income Share";
    var title = "Lorenz Curve"
    if( thumbnail ){
        var height = 70;
        xtitle = "";
        ytitle = "";
        title = "";
    }
    var width = Math.trunc( GOLDEN_RATIO*height);
    var data=[];
    console.log( "deciles" + result.lorenz_pre.toString());
    console.log( "lorenz_pre length" + result.lorenz_pre.length );
    // deciles levels are rhs. so push a 0,0
    data.push( {"popn1":0, "pre":0 });
    popn = 0.0;
    incr = 1/result.lorenz_pre.length;
    for( var i = 0; i < result.lorenz_pre.length; i++){
        popn += incr;
        data.push( {"popn1":popn, "pre":result.lorenz_pre[i] });
    }
    // var data_post= [];
    data.push( {"popn2":0, "post":0 });
    popn = 0.0;
    for( var i = 0; i < result.lorenz_post.length; i++){
        popn += incr;
        data.push( {"popn2":popn, "post":result.lorenz_post[i] });
    }
    data.push( {"popn3":0.0, "base":0.0});
    data.push( {"popn3":1.0, "base":1.0});
    var gini_vg = {
        "$schema": "https://vega.github.io/schema/vega-lite/v3.json",
        "title": title,
        "width": width,
        "height": height,
        "description": title,
        "data": {"values": data }, // , "post":data_post
        "layer":[
            {
                "mark": "line",
                "encoding":{
                    "x": { "type": "quantitative",
                           "field": "popn1",
                           "axis":{
                               "title": xtitle
                           }},
                    "y": { "type": "quantitative",
                           "field": "pre",
                           "axis":{
                              "title": ytitle
                           } },
                    "color": {"value":"blue"}
                } // encoding
            }, // pre layer line
            {
                "mark": "line",
                "encoding":{
                    "x": { "type": "quantitative",
                           "field": "popn2",
                           "axis":{
                              "title": xtitle
                           }},
                    "y": { "type": "quantitative",
                           "field": "post",
                           "axis":{
                              "title": ytitle
                           } },
                   "color": {"value":"red"}
               } // encoding
           }, // post line
          { // diagonal in grey
               "mark": "line",
               "encoding":{
                   "x": { "type": "quantitative",
                          "field": "popn3" },
                   "y": { "type": "quantitative",
                          "field": "base" },
                   "color": {"value":"#ccc"},
                   "strokeWidth": {"value": 1.0}
                   // "strokeDash":
               } // encoding
           },
        ]
    }
    vegaEmbed( targetId, gini_vg );
}

const GOLDEN_RATIO = 1.618
 
function createDecileBarChart( targetId, result, thumbnail ){
    var height = 300;
    var xtitle = "Deciles";
    var ytitle = "Gains in £s p.w.";
    var title = "Gains By Decile"
    if( thumbnail ){
        var height = 70;
        xtitle = "";
        ytitle = "";
        title = "";
    }
    var width = Math.trunc( GOLDEN_RATIO*height);
    var data=[];
    console.log( "deciles" + result.gains_by_decile.toString());
    console.log( "lorenz_pre[2] length" + result.gains_by_decile.length );
    for( var i = 0; i < result.gains_by_decile.length; i++){
        var dec = (i+1);
        data.push( {"decile":dec, "gain":result.gains_by_decile[i] });
    }
    var deciles_vg = {
        "$schema": "https://vega.github.io/schema/vega-lite/v3.json",
        "title": title,
        "width": width,
        "height": height,
        "description": title,
        "data": {"values": data }, // , "post":data_post
        "mark": "bar",
        "encoding":{
            "x": { "type": "ordinal",
                   "field": "decile",
                   "axis":{
                      "title": xtitle
                   }
             },
            "y": { "type": "quantitative",
                   "field": "gain",
                   "axis":{
                      "title": ytitle
                   }
            }
        } // encoding
    }
    console.log( "deciles_vg=" + JSON.stringify(deciles_vg) );

    vegaEmbed( targetId, deciles_vg );
}

function createMainOutputs( result ){
    // FIXME hack
    if (typeof result.gain_lose == 'undefined') {
        // the variable is defined
        loadOutput();
    }
    console.log( result.inequality );
    console.log( result.examples );
    console.log( result.overall_costs )
    $("#examples").html( result.examples );
    $("#gain-lose-table").html( result.gain_lose );
    $( '#conjoint-table' ).html( result.popularity );
    createDecileBarChart( 
        "#deciles-graph", 
        result, 
        false );
    $("#costs-table").html( result.costs );
    $("#overall-costs").html( result.overall_costs )
    $("#pov-table").html( result.poverty );
    $("#ineq-table").html( result.inequality );
    $("#big-costs-table").html( result.big_costs_table );
    $("#endnotes").html( result.endnotes );
    createLorenzCurve( 
        "#lorenz", 
        result,
        false );
}

function loadOutput(){
    // FIXME use asnc or something
    $.ajax(
        { url: "/conjoint/output",
        method: 'post',
        dataType: 'json',
        contentType: "application/json",
        data:""
        }).done(
            function( outp ){
                // if( outp.response == 'output_ready' ){
                    console.log( "submitForm; result %o", outp);
                    createMainOutputs( outp.data );
                // } else {
                //    return "";
                // }
            }
        );
}

function updateProgress( data ){
    console.log( "updateSTB  result.phase = " + data.phase );
    switch( data.phase ){
        case 'queued':
            $( "#progress-indicator").html( "<div class='alert alert-info' role='alert'>Run is in the job queue.</div>");
        case 'missing':
            $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Waiting for response ..</div>");
            break;
        case 'start':
            $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Run starting: starting pre-run routines.</div>");
            break;
        case 'weights':
            $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Generating sample weights (may take some time..).</div>");
            break;
        case 'disability_eligibility':
            $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Calibrating Disability Benefits.</div>");
            break;
        case 'starting':
            $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Pre-routines completed; run starting.</div>");
            break;
        case 'run':
            drawRunProgress( data );
            break;
        case 'dumping_frames':
            $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Calculations complete; now generating output.</div>");
            break;
        case 'end':
            console.log( "updateProgress; end encountered loading " ); 
            $("#progress-indicator").html( "<div></div>" );
            updater.stop();            
            loadOutput();
            break;  
        case 'na':
            updater.stop();
            break;  
        default:
            $("#progress-indicator").html( "<div class='alert alert-danger' role='alert'>Problem: run "+result.uuid+" can't be found.</div>");
            break;                                      
    }
}

function loadFromForm(){
    var data = {
        level: $("input:radio[name='Level']:checked").val(),
        tax: $( "input:radio[name='Tax']:checked" ).val(),
        funding: $( "input:radio[name='Funding']:checked" ).val(),
        eligibility: $( "input:radio[name='Eligibility']:checked" ).val(),
        means_testing: $( "input:radio[name='Means.Testing']:checked" ).val(),
        citizenship: $( "input:radio[name='Citizenship']:checked" ).val()
    }
    return data;
}

function loadParams( data ){
    $("input:radio[name='Level'][value='"+data.level+"']" ).prop('checked', true);
    $("input:radio[name='Tax'][value='"+data.tax+"']" ).prop('checked', true);
    $("input:radio[name='Funding'][value='"+data.funding+"']" ).prop('checked', true);
    $("input:radio[name='Eligibility'][value='"+data.eligibility+"']" ).prop('checked', true);
    $("input:radio[name='Means.Testing'][value='"+data.means_testing+"']" ).prop('checked', true);
    $("input:radio[name='Citizenship'][value='"+data.citizenship+"']" ).prop('checked', true);
}

function submitForm( action, target ){
     var url = "/conjoint/"+action;
     if( target != null ){
        url += "/"+target;
     }
     $("#mainform").validate();
     var dataset = JSON.stringify(loadFromForm());
     console.log( "submitForm; data = %o", dataset );
     // console.debug( "submitForm submitForm url="+url );
     $.ajax(
        { url: url,
         method: 'post',
         dataType: 'json',
         contentType: "application/json",
         data: dataset
        }).done(
            function( initialResult ){
                console.log( "submitForm; initialResult%o", initialResult);
                console.log( "target " + target );
                switch( action ){
                case'run':
                    // start updater if no immediate output
                    if( initialResult.response != "output_ready" ){
                        console.log( "starting run and timer");               
                        console.log( "initialResult" + initialResult);
                        var uri = '/conjoint/progress/';
                        updater = $.PeriodicalUpdater('/conjoint/progress', {
                            url: uri,         // URL of ajax request
                            cache: false,     // By default, don't allow caching
                            method: 'POST',    // method; get or post
                            data: '',         // array of values to be passed to the page - e.g. {name: "John", greeting: "hello"}
                            minTimeout: 1000, // starting value for the timeout in milliseconds
                            maxTimeout:64000, // maximum length of time between requests
                            multiplier: 2,    // if set to 2, timerInterval will double each time the response hasn't changed (up to maxTimeout)
                            maxCalls: 0,      // maximum number of calls. 0 = no limit.
                            maxCallsCallback: null, // The callback to execute when we reach our max number of calls
                            autoStop: 0,      // automatically stop requests after this many returns of the same data. 0 = disabled
                            autoStopCallback: null, // The callback to execute when we autoStop
                            cookie: false,    // whether (and how) to store a cookie
                            runatonce: false, // Whether to fire initially or wait
                            verbose: 0        // The level to be logging at: 0 = none; 1 = some; 2 = all
                        }, function( responseFromUpdater, success, xhr, handle) {
                            console.log( "progress: got %o", responseFromUpdater );
                            switch( responseFromUpdater.response ){
                                case 'output_ready':
                                    updater.stop();
                                    console.log( "updater stopped; main; loading output" );
                                    loadOutput();
                                    // createMainOutputs( responseFromUpdater.data );
                                break;
                                case 'has_progress':
                                    updateProgress( responseFromUpdater.data );
                                break;
                                case 'load_params':
                                    updateParamms( responseFromUpdater.data );
                                break;
                                case 'bad_request':
                                    console.log( "bad request %o", responseFromUpdater );
                                break;
                            }
                        });
                    } else {
                        loadOutput();
                        // createMainOutputs( initialResult.data );
                    }
                    break;
                case 'reset':
                    // FIXME something to reset parameters
                    // createMainOutputs( result.data );                    
                    loadParams( initialResult.data );
                    loadOutput();
                    break;
                }
            }
        ).fail(
            function( jqXHR, textStatus, errorThrown ){
                console.log( "failed with " + textStatus + " errorThrown "+errorThrown );
                console.log( "jqXHR.statusCode" + jqXHR.status + " text" + jqXHR.statusText );
            }
        );
}

$(document).ready(function(){
        $("mainform").submit(function(e){
                alert('submit intercepted');
                e.preventDefault(e);
        });
        submitForm("reset", null ); // FIXME make this params?
        
    });

</script>
</html>
