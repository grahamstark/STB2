<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <title>Scot... </title>
    <link rel="icon" href="img/favicon.ico?v=2.0.0" type="image/x-icon">
    <link rel="stylesheet" href="css/stb-bootstrap.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">

    </script><script type='text/javascript' src='js/jquery.js'></script>
    <script type='text/javascript' src='js/jquery.periodicalupdater.js'></script>
     <!-- bootstrap -->
    <script src="js/bootstrap.bundle.js"></script>
    <!-- vega graphics -->
    <script type="text/javascript" src="js/vega-lite.min.js"></script>
    <script type="text/javascript" src="js/vega.js"></script>
    <script type="text/javascript" src="js/vega-embed.min.js"></script>

    <!-- templates -->
    <script type='text/javascript' src="js/mustache.min.js"></script>

</head>

<body class='text-bg--primary'>
    <div class='container-fluid'>
        <nav class="navbar navbar-expand-lg text-primary">
            <ul class="nav">
                <li class="nav-item"><a class='nav-link' href='https://stb.virtual-worlds.scot/scotbudg/'>A Scottish Budget</a></li>
                <li class="nav-item"><a class="nav-link active" aria-current="page" href='https://ubi.virtual-worlds.scot/'>Basic Income</a></li>
                <li class="nav-item"><a class='nav-link' href='https://stb.virtual-worlds.scot/bcd/'>Budget Constraints</a></li>
                <li class="nav-item"><a class='nav-link' href='https://stb-blog.virtual-worlds.scot/'>Blog</a></li>
            </ul>
        </nav>
        <header>
            <h1>...r Scotland</h1>
        </header>
        <div class='container-fluid'>
            <div class='row'>
                <div class='col'><!-- 1st col -->
                    <form id='mainform'>


                        <div class='container-fluid'>
                            <div class='row'>
                                <div class='col'>  
                                    <div class="row">
                                        <div class="col">

                                        <h4>Income Tax</h4>
                                            <input type="hidden" id="it-n" name="it-n" value=""/>
                                            <table id='it-table' class="table table-striped table-sm">
                                                <caption>Rates in %, bands in &pound;s pa</caption>
                                                <thead>
                                                    <tr class="">
                                                        <th>Rate (%)</th>
                                                        <th>Band (£pa)</th>
                                                        <th></th>
                                                        <th></th>
                                                    </tr>
                                                </thead>

                                                <tbody id='it-rows'>
                                                </tbody>

                                            </table>
                                        </div>
                                    </div><!-- inner row -->
                                    <div class="row">
                                        <div class="col">
                                            <label for='it-pa' class='form-label'>Personal Allowance £pa</label>
                                            <input id='it-pa' type='number'  min='0' max='100000' value='' step='1' size="12" class='form-control w-50'/>
                                        </div>
                                    </div>

                                </div> <!-- col -->
                                <div class='col'>       
                                    <h4>National Insurance</h4> 
                                    <input type="hidden" id="ni-n" name="ni-n" value=""/>
                                    <table class="table table-striped table-sm">
                                        <tbody>
                                            <tr class="" >
                                                <th>Rate</th>
                                                <th>Band</th>
                                            </tr>
                                            <tr class="">
                                                <td><input id='ni-r-1' name='ni-r-1' min='0' max='100' step='0.1' value='' class='' /></td>
                                                <td><input id='ni-b-1' name='ni-b-1' min='0' max='1000000' step='1' value='' class='' /></td>
                                                <td><span onclick='' data-bs-toggle="popover"  data-bs-placement="right" data-bs-content="Insert New Row"><i class="bi-plus-circle text-success" style="font-size: 1rem"></i></span></td>
                                                <td><span onclick='' data-bs-toggle="popover"  data-bs-placement="right" data-bs-content="Delete This Row"><i class="bi-dash-circle text-danger" style="font-size: 1rem"></i></span></td>
                                            </tr>
                                            <tr class="">
                                                <td><input id='ni-r-2' name='ni-r-2' min='0' max='100' step='0.1' value='' class='' /></td>
                                                <td><input id='ni-b-2' name='ni-b-2' min='0' max='1000000' step='1' value='1' class='' /></td>
                                                <td><span onclick='' data-bs-toggle="popover"  data-bs-placement="right" data-bs-content="Insert New Row"><i class="bi-plus-circle text-success" style="font-size: 1rem"></i></span></td>
                                                <td><span onclick='' data-bs-toggle="popover"  data-bs-placement="right" data-bs-content="Delete This Row"><i class="bi-dash-circle text-danger" style="font-size: 1rem"></i></span></td>
                                            </tr>
                                        </tbody>
                                    </table>   

                                </div>
                               

                                <div class='col'>       
                                    <h4>Means-Tested Benefits</h4>  
                                </div>
                                <div class='col'>       
                                    <h4>Other Benefits</h4>  
                                </div>
                            </div> <!-- row -->
                        </div> <!-- container -->
                    </form>
                </div>
            </div>
        </div>
    </div> <!-- main container -->
    <button class='button' value='click me' onclick='insertRow( "tax-table", 99, "it" )'>CLICK</button>
</body>

<script type='text/javascript'>

    function makeTypename( type ){
        return type=='rate' ? 'r' : 'b';
    }

    function makeId( n, name, type ){
        var typename = makeTypename( type );
        return name + "-" + typename + '-' + n;
    }

    function makeInput( n, name, type ){
        var typename = makeTypename( type );
        var min=-999999999999999;
        var max=9999999999999999;
        var step=1;
        if( type == 'band' ){
            min=0.0;
            max=1000000;
        } else if( type=='rate'){
            min=0.0;
            max=100;
            step=0.01;
        }
        var id = makeId( n, name, type );
        return "<input id='"+id+"' name='"+id+"' type='number' min='"+min+"' max='"+max+"' step='"+step+"' value='' class='' />";
    }

    function makeAddDel( n, name, isdel ){
        var action = 'addtax';
        var icon = "bi-plus-circle text-success";
        if(isdel===true){
            action = 'deltax';
            icon = "bi-dash-circle text-danger";
        }
        return "<span onclick='submitForm(\""+action+"\", "+n+")' ><i class=\""+icon+"\" style=\"font-size: 1rem\"></i></span>";
    }

    function makeRow( n, name ){
        const id = name+"-"+n;
        const row = "<tr id='"+id+"'><td>"+makeInput( n, name, 'rate' )+"</td><td>"+makeInput( n, name, 'band' )+"</td><td>"+makeAddDel( n, name, false )+"</td><td>"+makeAddDel( n, name, true )+"</td></tr>";
        console.log( "made row as |"+row+"|" );
        return row;
    }

    function insertRow( which, n, name ){
        $("#"+which ).append( makeRow( n, name ));
    }

    function loadTax( name, rates, bands ){
        var nr = rates.length;
        var nb = bands.length;
        console.log( "nr="+nr + " nb = " + nb );
        $( "#"+name+"-n").val( nr );
        for( var i = 1; i <= nr; i++ ){
            var rp = "#"+name+"-r-"+i;
            $( rp ).val( rates[i-1]);
            rb = "#"+name+"-b-"+i;            
            if( i == nr ){            
                console.log( "on last band " + i );
                console.log( "last band = " + bands[i-1] );
                if(( nr > nb )||( bands[i-1] > 99999999 )){ // no top set
                    $( rb ).hide(); // attr('disabled', 'disabled');
                } else {
                    $( rb ).val( bands[i-1]);
                }
            } else {
                $( rb ).val( bands[i-1]);           
            } 
        }
        /*
        for( var i = nr+1; i <= 10; i++ ){
            var k = "#"+name+"-"+i;
            console.log( "hiding " + k );
            $( k ).hide();
        }
        */
    }

    function initialiseTable( which, rates, bands ){
        var n = rates.length;
        var target = which+ "-rows";
        for( var i = 1; i <= n; i++ ){
            insertRow( target, i, which );
        }
        loadTax( which, rates, bands );
    }


    function loadData( data ){
        loadtax( "it", data.taxrates, data.taxbands );
        loadtax( "ni", data.nirates, data.nibands );
        $( "#it-pa").val( data.taxallowance );
    }

    function scrapetax( name ){
        var rates = [];
        var bands = [];
        var nr = parseInt($( "#"+name+"-n").val());
        for( var i = 1; i <= nr; i++ ){
            var rp = "#"+name+"-r-"+i;
            var rb = "#"+name+"-b-"+i;
            rates.push( parseFloat($( rp ).val()));
            bands.push( parseFloat($( rb ).val()));
        }
        console.log( "rates=" + rates );
        return [rates, bands];
    }

    // loadtax( "it", [1,2,101], [1000,2000,999999999999999]);
    // loadtax( "ni", [11,22], [100,20]);

    function scrapeData(){
        var tbs = scrapetax( "it");
        console.log( "tbs=" + tbs );
        var nbs = scrapetax( "ni");
        var data = {
            taxrates: tbs[0],
            taxbands: tbs[1],
            nirates: nbs[0],
            nibands: nbs[1],
            taxallowance: parseFloat($( "#it-pa" ).val()),
            target: -1
        }
        console.log( "data.taxrates " + data.taxrates );
        return data;
    }

function submitForm( action, target ){
     const url = "/gini/"+action+"/"+target;
     console.debug( "submitForm url="+url );
     $.ajax(
        { url: url,
         method: 'get',
         dataType: 'json',
         data: {}
        }).done(
            function( result ){
                console.log( "submitForm; result %o", result );
                console.log( "target " + target );
            }
        ).fail(
            function( jqXHR, textStatus, errorThrown ){
                console.log( "failed with " + textStatus + " errorThrown "+errorThrown );
                console.log( "jqXHR.statusCode" + jqXHR.status + " text" + jqXHR.statusText );
            }
        );
}


function loadDefaults(){
    $.ajax(
        // make the UBI bit a variable
        { url: "/gini/addtax/3",
         method: 'get',
         dataType: 'json',
         data: {}
        }).done(
            function( result ){
                console.log( "loadDefaults; result %o", result );
            }
        ).fail(
            function( jqXHR, textStatus, errorThrown ){
                console.log( "failed with " + textStatus + " errorThrown "+errorThrown );
                console.log( "jqXHR.statusCode" + jqXHR.status + " text" + jqXHR.statusText );
            }
        );
}

$(document).ready(function(){
        loadDefaults();
        initialiseTable( "it", [1,4,5,6], [1000,30000,500000] )
        $("mainform").submit(function(e){
                alert('submit intercepted');
                e.preventDefault(e);
        });
    });

</script>
</html>
