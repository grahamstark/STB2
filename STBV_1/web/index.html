<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <title>Scot... </title>
    <link rel="icon" href="img/favicon.ico?v=2.0.0" type="image/x-icon">
    <link rel="stylesheet" href="css/stb-bootstrap.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    </script><script type='text/javascript' src='js/jquery.js'></script>
    <script type='text/javascript' src='js/jquery.periodicalupdater.js'></script>
    <script type='text/javascript' src='js/jquery.validate.js'></script>
     <!-- bootstrap -->
    <script src="js/bootstrap.bundle.js"></script>
    <!-- vega graphics -->
    <script type="text/javascript" src="js/vega-lite.min.js"></script>
    <script type="text/javascript" src="js/vega.js"></script>
    <script type="text/javascript" src="js/vega-embed.min.js"></script>
    <!-- templates -->
    <script type='text/javascript' src="js/mustache.min.js"></script>
    <style>
        .error{ color: red;}
        .changed{ background-color: yellow; }
    </style>
</head>
<body class='text-bg--primary'>
    <div class='container-fluid'>
        <nav class="navbar navbar-expand-lg text-primary">
            <ul class="nav">
                <li class="nav-item"><a class='nav-link' href='https://stb.virtual-worlds.scot/scotbudg/'>A Scottish Budget</a></li>
                <li class="nav-item"><a class="nav-link active" aria-current="page" href='https://ubi.virtual-worlds.scot/'>Basic Income</a></li>
                <li class="nav-item"><a class='nav-link' href='https://stb.virtual-worlds.scot/bcd/'>Budget Constraints</a></li>
                <li class="nav-item"><a class='nav-link' href='https://stb-blog.virtual-worlds.scot/'>Blog</a></li>
            </ul>
        </nav>
        <header>
            <h1>...r Scotland</h1>
        </header>
        <div class='container-fluid'>
            <div class='row'>
                <div class='col'><!-- 1st col -->
                    <form id='mainform' action="thing" method="POST">
                        <div class='container-fluid'>
                            <div class='row'>
                                <div class='col'>
                                    <div class="row">
                                        <div class="col">
                                            <h4>Income Tax</h4>
                                            <input type="hidden" id="tax-n" name="tax-n" value=""/>
                                            <table id='it-table' class="table table-sm table-striped">
                                                <caption>Rates in %, bands in &pound;s pa</caption>
                                                <thead>                                                    
                                                    <tr>
                                                        <th>Rate (%)</th>
                                                        <th>Band (£pa)</th>
                                                        <th></th>
                                                        <th></th>
                                                    </tr>
                                                </thead>

                                                <tbody id='tax-rows'>
                                                </tbody>

                                            </table>
                                            <div class="row">
                                                <div class="col">                                                    
                                                    <label for='taxallowance' class='form-label'>Personal Allowance £pa</label>
                                                    <input id='taxallowance' type='number'  min='0' max='100000' value='' step='1' size="12" class='form-control w-50'/>
                                                </div>
                                            </div>

                                        </div>
                                    </div><!-- inner row -->                                    
                                </div> <!-- col -->
                                <div class='col'>
                                    <h4>National Insurance</h4>
                                    <input type="hidden" id="ni-n" name="ni-n" value=""/>
                                    <table class="table table-sm table-striped">
                                        <caption>Rates in %, bands in &pound;s pw</caption>
                                        <thead>
                                            <tr>
                                                <th>Rate (%)</th>
                                                <th>Band (£pw)</th>
                                                <th></th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id='ni-rows'>
                                        </tbody>
                                    </table>
                                </div>
                                <div class='col'>
                                    <h4>Means-Tested Benefits</h4>
                                </div>
                                <div class='col'>
                                    <h4>Other Benefits</h4>
                                </div>
                            </div> <!-- row -->
                            <div class="row">
                                <div class="col"></div>
                                <div class="col"></div>
                                <div class="col">
                                    <button  type="button" class='btn btn-warning' value='' onclick='submitForm( "reset" )'>Reset</button>
                                </div>
                                <div class="col">
                                    <button  type="button" class='btn btn-success' value='' onclick='submitForm( "submit" )'>Submit</button>
                                </div>
                            </div>
                        </div> <!-- container -->
                    </form>
                </div>
            </div>
        </div>
    </div> <!-- main container -->
</body>

<script type='text/javascript'>

    const BIG_A = 9999999999;

    function makeTypename( type ){
        return type=='rate' ? 'r' : 'b';
    }

    function makeId( n, name, type ){
        var typename = makeTypename( type );
        return name + "-" + typename + '-' + n;
    }

    function makeInput( n, name, type ){
        var typename = makeTypename( type );
        var min=-BIG_A;
        var max=BIG_A;
        var step=1;
        if( type == 'band' ){
            min=0.0;
            max=BIG_A;
        } else if( type=='rate'){
            min=0.0;
            max=100;
            step=0.01;
        }
        var id = makeId( n, name, type );
        return "<input id='"+id+"' name='"+id+"' type='number' min='"+min+"' max='"+max+"' step='"+step+"' value='' class='' />";
    }

    function makeAddDel( n, name, isdel ){
        var action = 'add'+name;
        var icon = "bi-plus-circle text-success";
        if(isdel===true){
            action = 'del'+name;
            icon = "bi-dash-circle text-danger";
        }
        return "<span onclick='submitForm(\""+action+"\", "+n+")' ><i class=\""+icon+"\" style=\"font-size: 1rem\"></i></span>";
    }

    function makeRow( n, name, addDel ){
        const id = name+"-"+n;
        var row = "<tr id='"+id+"'><td>"+makeInput( n, name, 'rate' )+"</td><td>"+makeInput( n, name, 'band' )+"</td><td  class='align-middle'>"+makeAddDel( n, name, false )+"</td>";
        if( addDel ){
            row += "<td class='align-middle'>"+makeAddDel( n, name, true )+"</td>";
        } else {
            row += "<td></td>";
        }
        row += "</tr>";
        // console.log( "made row as |"+row+"|" );
        return row;
    }

    function insertRow( which, n, name, addRow ){
        $("#"+which ).append( makeRow( n, name, addRow ));
    }

    function loadTax( name, rates, bands, defrates, defbands ){
        var nr = rates.length;
        var nb = bands.length;
        // console.log( "nr="+nr + " nb = " + nb );
        $( "#"+name+"-n").val( nr );
        for( var i = 1; i <= nr; i++ ){
            var rp = "#"+name+"-r-"+i;
            $( rp ).val( rates[i-1]);
            var rb = "#"+name+"-b-"+i;
            if( i == nr ){
                $( rb ).hide();            
            } else {
                $( rb ).val( bands[i-1]);
            }
        }
    }

    function initialiseTable( which, rates, bands, defrates, defbands ){
        var n = rates.length;
        var target = which+ "-rows";
        $( "#"+target ).children().remove();
        var addDel = n > 1;
        for( var i = 1; i <= n; i++ ){
            insertRow( target, i, which, addDel );
        }
        loadTax( which, rates, bands, defrates, defbands );
    }


    function loadData( data ){
        loadtax( "tax", data.taxrates, data.taxbands );
        loadtax( "ni", data.nirates, data.nibands );
        $( "#taxallowance").val( data.taxallowance );
    }

    function scrapetax( name ){
        var rates = [];
        var bands = [];
        var nrt = "#"+name+"-n";
        // console.log( "count nrt key = " + nrt );
        var nr = parseInt($( nrt ).val());
        // console.log( name + " : got nr as " + nr );
        for( var i = 1; i <= nr; i++ ){
            var rp = "#"+name+"-r-"+i;
            var rb = "#"+name+"-b-"+i;
            rates.push( parseFloat($( rp ).val()));
            var rr = parseFloat($( rb ).val());
            if( Number.isNaN(rr)){
                rr = BIG_A;
            }
            bands.push( rr );
        }
        // console.log( "rates=" + rates );
        return [rates, bands];
    }

    function scrapeData(){
        var tbs = scrapetax("tax");
        // console.log( "tbs=" + tbs );
        var nbs = scrapetax( "ni");
        var data = {
            taxrates: tbs[0],
            taxbands: tbs[1],
            nirates: nbs[0],
            nibands: nbs[1],
            taxallowance: parseFloat($( "#taxallowance" ).val()),
            target: -1
        }
        // console.log( "data.taxrates " + data.taxrates );
        return data;
    }

function getClass( a, b ){
    return (a == b) ? '' : "changed";
}

function populateForm( pars, defaults ){
    initialiseTable( "tax", 
        pars.taxrates, 
        pars.taxbands,
        defaults.taxrates,
        defaults.taxbands );
    initialiseTable( "ni", 
        pars.nirates, 
        pars.nibands,
        defaults.nirates, 
        defaults.nibands
            );
    $( "#taxallowance").val( pars.taxallowance );
    var c = getClass(pars.taxallowance,defaults.taxallowance);
    $( "#taxallowance").toggleClass( c );
}

function submitForm( action, target ){
     var url = "/stb2/"+action;
     if( target != null ){
        url += "/"+target;
     }
     $("#mainform").validate();
     const dataset = JSON.stringify(scrapeData());
     // console.log( "submitForm; data = %o", dataset );
     // console.debug( "submitForm submitForm url="+url );
     $.ajax(
        { url: url,
         method: 'post',
         dataType: 'json',
         contentType: "application/json",
         data: dataset
        }).done(
            function( result ){
                console.log( "submitForm; result %o", result );
                console.log( "target " + target );
                populateForm( result[0].pars, result[1].def )
            }
        ).fail(
            function( jqXHR, textStatus, errorThrown ){
                console.log( "failed with " + textStatus + " errorThrown "+errorThrown );
                console.log( "jqXHR.statusCode" + jqXHR.status + " text" + jqXHR.statusText );
            }
        );
}

$(document).ready(function(){
        $("mainform").submit(function(e){
                alert('submit intercepted');
                e.preventDefault(e);
        });
        submitForm("params");        
    });

</script>
</html>
